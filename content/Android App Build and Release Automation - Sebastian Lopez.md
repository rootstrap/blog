# **How to Automate Android App Builds using Fastlane & GitHub Actions**

<img src="images/android_robot.jpg" height="500" />




Now, I am going to describe the approach we implemented for Android CI/CD making use of Fastlane and a CI system (GitHub Actions). We used Amazon S3 to store signing artifacts, but any system where we could safely store encrypted files will work.


For this example, we'll use an Android app developed with React Native, but the same approach also works when using other languages supported by the Android SDK, such as Kotlin. The key assumption here is that we will use [Gradle](https://developer.android.com/studio/releases/gradle-plugin) when building the APK.



## Prep work

### Registering Apps

Within our Android project, we will define multiple [build flavors](https://developer.android.com/studio/build/build-variants), specified in our `build.gradle` file. For each of these, we would register an application in the Google Play Console.
After registering apps we will need the following:
* A keystore file generated with Android Studio: https://developer.android.com/studio/publish/app-signing#generate-key
* An API key (in json format) with permissions to publish apps into the Play Console: https://developers.google.com/android-publisher

Both files should be placed in a secure location, with the credentials required to retrieve them stored in the repo Secrets.

### Code Signing & API keys

In order to distribute our app, our APK needs to be signed with a certificate generated by Google. Unlike iOS, Fastlane does not offer an equivalent to their match feature which can handle certificate creation and management end to end. So, we need to generate it manually once from Android Studio, following the steps in their [User Guide](https://developer.android.com/studio/publish/app-signing), and then store it somewhere our CICD can retrieve it. 

For the latter, we will make use of [AWS S3](https://aws.amazon.com/s3/getting-started/). This is a good option for us as we typically use AWS S3 in all our projects, and have to set AWS credentials in our working environment. One single bucket, encrypted with [AWS KMS](https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingKMSEncryption.html) allows us to securely handle our Certificates, Keystores and other sensitive files for all our projects. 

In order to upload our APK via the [Google Play Developer API](https://developers.google.com/android-publisher), we also need an API JSON keyfile associated with a service account that will allow Fastlane to authenticate. After creating one on the [Google Play console](https://console.cloud.google.com/iam-admin/serviceaccounts). We can either store the entire JSON string as a Secret to retrieve as environment variable, or do the same as with the keystore, and place it on S3 for GitHub Actions to download and use during the build run (we will use the latter in this example).

### Environment Variables

Our workflow should have the following sensitive keys defined as [Secrets](https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets) in the GitHub repo: 
* AWS keys (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`) associated with permissions to interact with the target bucket.
* Keystore and Upload Key(Alias) name and passwords (`ANDROID_RELEASE_STORE_PASSWORD`, `ANDROID_RELEASE_KEY_ALIAS`, `ANDROID_RELEASE_KEY_PASSWORD`) 
* Slack webhook URL and channel name (`SLACK_URL`, `SLACK_CHANNEL`) for sending notifications upon build completion.


## The Android Fastfile

### Build Steps
This lane provides the generic steps to run the defined tasks for cleaning the build directory, installing Android dependencies, and building our APK for the desired flavor, using [Gradlew](https://docs.fastlane.tools/actions/gradle/).

https://gist.github.com/sebalopez/a09976693f0b87839b6a801c5e6fb610

### Publish Steps
This lane retrieves the version and build number of our package and submits it to the Play Store, before finishing with a Slack notification that the release was successful.  

https://gist.github.com/sebalopez/0c71d25963d6f179f37dbb35538a31d4

### Release Targets
After defining the generic steps for building and releasing, we can then reuse them for multiple flavors/targets by creating lanes for each.

https://gist.github.com/sebalopez/44b014e7d7f311cb1b35a338c142be2c

Alternatively we could define "debug only" lanes, which only run the build for local use without publishing, or store the APK on an alternate location (such as another S3 bucket).

## The GitHub Actions Workflow

After we have a working Fastlane configuration, the next step is to tie it to a CI/CD system so the build runs automatically with every push to the right branches. 
This is how this looks for a React Native application using an Ubuntu runner in GitHub Actions:

https://gist.github.com/sebalopez/99f734d92cd6d84f423dee647a4e269b.js

In a nutshell, this workflow:
* Checks out our code
* Installs the required version of Node
* Installs Node dependencies for the RN project
* Downloads the keystore and json API key file
* Generates a .env file with all the environment variables Gradle will insert into the APK
* Installs Fastlane and associated plugins (using [Bundler](https://bundler.io/))
* Runs the corresponding Lane

##  Summary

Much like before with iOS, we have gone through another example of how to automate our mobile app deployment using Fastlane, a powerful free tool specifically designed for this, and showcased GitHub Actions as a good CI/CD system that can integrate with Fastlane to trigger our pipelines automatically and in a secure environment. 

You can find complete Fastlane working examples in our Open Source boilerplate projects, [Android Base](https://github.com/rootstrap/android-base) and [React Native Base](https://github.com/rootstrap/react-native-base).

All these cover just a couple of the many use cases you can apply these tools for -we highly recommend you to go through their extensive documentation sites.
